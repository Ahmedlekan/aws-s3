# AWS Key Management Service (KMS)

AWS Key Management Service (KMS) is a fully managed service that makes it easy to create, store, and manage cryptographic keys. It provides a secure and scalable solution for encrypting data and managing access to encryption keys. Below is a detailed explanation of KMS, its features, and best practices for using it effectively.

## Key Features

Regional and Public Service:

- KMS is a regional service, meaning keys are isolated to the region where they are created.

- It is a public service, accessible via AWS APIs, CLI, and SDKs.

Key Management:

- Create, store, and manage symmetric and asymmetric keys.

- Perform cryptographic operations such as encryption, decryption, signing, and verification.

Security:

- Keys never leave KMS; all cryptographic operations are performed within the service.

- Complies with FIPS 140-2 (Level 2) security standards.

Data Encryption:

- KMS can directly encrypt data up to 4 KB in size.

- For larger data, KMS generates Data Encryption Keys (DEKs).


## KMS Keys

### Logical Structure

KMS keys are logical resources that include:

- Key ID: Unique identifier for the key.

- Creation Date: When the key was created.

- Policy: Defines who can access and manage the key.

- Description: Optional description of the key.

- State: Enabled, disabled, or pending deletion.

### Physical Key Material

Each KMS key is backed by physical key material:

- AWS-Generated: Key material is generated by KMS.

- Customer-Imported: Key material is imported by the customer.


## Data Encryption Keys (DEKs)

### How DEKs Work

Generate Data Key:

- KMS generates a plaintext and ciphertext version of the DEK.

- The plaintext key is used to encrypt data locally.

- The ciphertext key is the encrypted version of the DEK, which can be stored alongside the encrypted data.

Encrypt Data:

- Use the plaintext DEK to encrypt data.

- Discard the plaintext DEK after encryption.

Store Encrypted Data:

- Store the encrypted data and the ciphertext DEK together.

- To decrypt the data, use KMS to decrypt the ciphertext DEK and retrieve the plaintext DEK.

Use Case

DEKs are used for encrypting data larger than 4 KB (e.g., files, databases, or backups).


## Key Concepts

1. Regional Isolation

    KMS keys are isolated to the region where they are created and cannot be transferred to another region.

2. Key Ownership

    AWS-Owned Keys:

      - Managed by AWS and used for services like S3, EBS, and RDS.

      - Customers do not have direct control over these keys.

    Customer-Owned Keys:

      - Managed by the customer.

      - Can be AWS-Managed (created and managed by AWS for specific services) or Customer-Managed (fully controlled by the customer).

3. Key Rotation

    KMS supports automatic key rotation for customer-managed keys:

      - A new backing key is generated annually.

      - The previous backing key is retained for decryption of older data.

      - Key rotation does not require re-encryption of existing data.

4. Aliases

    - Aliases are friendly names for KMS keys (e.g., alias/my-key).

    - Aliases can be updated to point to different keys, simplifying key management.


## Key Policies and Security

1. Key Policies

    Every KMS key has a key policy, which is a resource-based policy that defines who can access and manage the key.

    Key policies are the primary mechanism for controlling access to KMS keys.

2. IAM Policies

    IAM policies can be used to grant permissions for KMS actions (e.g., kms:Encrypt, kms:Decrypt).

    IAM policies must be combined with key policies to grant access.

3. Grants

    Grants provide temporary access to KMS keys for specific operations.

    Grants are useful for delegating access to AWS services or other users.



## Encrypt and Decrypt Battleplans With KMS

1. Configure key

![Image](https://github.com/user-attachments/assets/5fa44434-c2e6-4ac0-b3b2-ac565fb53560)

2. Add Labels

- Alias

![Image](https://github.com/user-attachments/assets/ced7c357-f957-4295-ab38-52c715748426)

3. Define key administrative permissions

![Image](https://github.com/user-attachments/assets/492022f5-de03-4977-9298-c669dbda2d41)

4. Define key usage permissions

![Image](https://github.com/user-attachments/assets/42bc08a6-5be8-4447-b261-c3dbb12c4522)

5. Edit key policy

```bash
{
	"Id": "key-consolepolicy-3",
	"Version": "2012-10-17",
	"Statement": [
		{
			"Sid": "Enable IAM User Permissions",
			"Effect": "Allow",
			"Principal": {
				"AWS": "arn:aws:iam::123456789:root"
			},
			"Action": "kms:*",
			"Resource": "*"
		},
		{
			"Sid": "Allow access for Key Administrators",
			"Effect": "Allow",
			"Principal": {
				"AWS": "arn:aws:iam::123456789:user/itadmin"
			},
			"Action": [
				"kms:Create*",
				"kms:Describe*",
				"kms:Enable*",
				"kms:List*",
				"kms:Put*",
				"kms:Update*",
				"kms:Revoke*",
				"kms:Disable*",
				"kms:Get*",
				"kms:Delete*",
				"kms:TagResource",
				"kms:UntagResource",
				"kms:ScheduleKeyDeletion",
				"kms:CancelKeyDeletion",
				"kms:RotateKeyOnDemand"
			],
			"Resource": "*"
		},
		{
			"Sid": "Allow use of the key",
			"Effect": "Allow",
			"Principal": {
				"AWS": "arn:aws:iam::123456789:user/itadmin"
			},
			"Action": [
				"kms:Encrypt",
				"kms:Decrypt",
				"kms:ReEncrypt*",
				"kms:GenerateDataKey*",
				"kms:DescribeKey"
			],
			"Resource": "*"
		},
		{
			"Sid": "Allow attachment of persistent resources",
			"Effect": "Allow",
			"Principal": {
				"AWS": "arn:aws:iam::123456789:user/itadmin"
			},
			"Action": [
				"kms:CreateGrant",
				"kms:ListGrants",
				"kms:RevokeGrant"
			],
			"Resource": "*",
			"Condition": {
				"Bool": {
					"kms:GrantIsForAWSResource": "true"
				}
			}
		}
	]
}
```

6. Review

- Review all the configuration

7. Open cloudshell

- Paste this to create a battleplan file

```bash
echo "Find all the doggos, distarct them with the yumz" > battleplan.txt
```

- use the cat command to confirm battleplan file you created 

```bash
cat battleplan.txt
```

- encrypt the battleplan file

```bash
aws kms encrypt \
    --key-id 1234abcd-12ab-34cd-56ef-1234567890ab \
    --plaintext fileb://battleplan.txt \
    --output text \
    --query CiphertextBlob | base64 \
    --decode > not_battleplan.enc
```
- Replace the key-id with your kms key-id

- Use cat to confirm the file you encrypt

```bash
cat not_battleplan.enc
```
![Image](https://github.com/user-attachments/assets/cb569f5e-f104-4c28-879b-0bd3ad534b02)


- decrypt the not_battleplan.enc

```bash
aws kms decrypt \
    --ciphertext-blob fileb://not_battleplan.enc \
    --output text \
    --query Plaintext | base64 --decode > decryptedplan.txt
```

- Use cat command to confirm the decryptedplan file

```bash
cat decryptedplan.txt
```
![Image](https://github.com/user-attachments/assets/c60c65e4-b047-4d96-8f05-463893f20220)


## Conclusion

AWS KMS is a powerful and secure service for managing cryptographic keys and performing encryption operations. By understanding its features—such as KMS keys, DEKs, key policies, and key rotation—you can effectively secure your data and comply with regulatory requirements. Follow best practices to optimize key management and ensure the security of your encryption workflows.


